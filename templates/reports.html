<!doctype html>
<html lang="{{ ui['html_lang'] }}">
<head>
    <meta charset="utf-8">
    <title>{{ ui['title'] }} – {{ ui['reports_headline'] }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            base: '#0f172a',
                            accent: '#a3e635',
                            soft: '#1e293b'
                        }
                    },
                    fontFamily: {
                        display: ['"Plus Jakarta Sans"', 'ui-sans-serif', 'system-ui']
                    }
                }
            }
        };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
          rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body class="theme-dark min-h-screen bg-slate-950 text-slate-100 font-display antialiased">
{% set loader_text = ui['loading_overlay'] %}{% include '_loader.html' %}
<div class="relative">
    <div class="mx-auto flex min-h-screen w-full max-w-6xl flex-col gap-8 px-6 py-8 md:px-12">
        <header class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
            <div class="flex flex-col gap-2">
                <p class="text-xs uppercase tracking-[0.35em] text-lime-300/80">{{ ui['header_tagline'] }}</p>
                <h1 class="text-3xl font-semibold text-white md:text-4xl">{{ ui['reports_headline'] }}</h1>
                <p class="max-w-3xl text-sm text-slate-300 md:text-base">{{ ui['reports_subheadline'] }}</p>
            </div>
            <div class="flex flex-col gap-2 md:items-end">
                <div class="flex flex-wrap gap-3">
                    <a href="{{ url_for('index', lang=current_language) }}"
                       class="inline-flex items-center gap-2 rounded-2xl border border-white/15 bg-white/5 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:border-lime-300 hover:bg-white/10 hover:text-white">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M3 11l9-8 9 8"/>
                            <path d="M5 12v8h5v-5h4v5h5v-8"/>
                        </svg>
                        <span>{{ ui['report_home_button'] }}</span>
                    </a>
                    {% if report %}
                        <div class="flex flex-wrap gap-2">
                            <a href="{{ url_for('export_report', fmt='csv') }}{% if export_query_string %}?{{ export_query_string }}{% endif %}"
                               class="inline-flex items-center gap-2 rounded-2xl border border-white/15 bg-white/5 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:border-lime-300 hover:bg-white/10 hover:text-white">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M12 5v14"/>
                                    <path d="M19 12l-7 7-7-7"/>
                                </svg>
                                <span>{{ ui['report_export_csv'] }}</span>
                            </a>
                            <a href="{{ url_for('export_report', fmt='xlsx') }}{% if export_query_string %}?{{ export_query_string }}{% endif %}"
                               class="inline-flex items-center gap-2 rounded-2xl border border-white/15 bg-white/5 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:border-lime-300 hover:bg-white/10 hover:text-white">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M4 4h16v16H4z"/>
                                    <path d="m9 9 6 6m0-6-6 6"/>
                                </svg>
                                <span>{{ ui['report_export_xlsx'] }}</span>
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </header>

        <main class="flex flex-col gap-8 pb-6">
            {% if report %}
                <section class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                    <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-4">
                        <p class="text-xs uppercase tracking-wide text-slate-500">{{ ui['report_table_period'] }}</p>
                        <p class="mt-2 text-lg font-semibold text-white">{{ report.params.start_date }}
                            → {{ report.params.end_date }}</p>
                    </div>
                    <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-4">
                        <p class="text-xs uppercase tracking-wide text-slate-500">{{ ui['radius_label'] }}</p>
                        <p class="mt-2 text-lg font-semibold text-white">{{ '%.0f'|format(report.params.radius) }}
                            km</p>
                    </div>
                    <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-4">
                        <p class="text-xs uppercase tracking-wide text-slate-500">{{ ui['granularity_label'] }}</p>
                        <p class="mt-2 text-lg font-semibold text-white">
                            {% if report.params.granularity == 'day' %}
                                {{ ui['granularity_option_daily'] }}
                            {% elif report.params.granularity == 'month' %}
                                {{ ui['granularity_option_monthly'] }}
                            {% else %}
                                {{ ui['granularity_option_yearly'] }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-4">
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                            <div>
                                <p class="text-xs uppercase tracking-wide text-slate-500">{{ ui['report_station_usage_found'] }}</p>
                                <p class="mt-1 text-2xl font-semibold text-white">{{ report.station_count }}</p>
                            </div>
                            <div>
                                <p class="text-xs uppercase tracking-wide text-slate-500">{{ ui['report_station_usage_used'] }}</p>
                                <p class="mt-1 text-2xl font-semibold text-white">{{ report.used_station_count or 0 }}</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="rounded-3xl border border-white/10 bg-slate-900/60 p-6">
                    <div class="flex items-center justify-between gap-3">
                        <h2 class="text-lg font-semibold text-white">{{ ui['report_chart_title'] }}</h2>
                    </div>
                    <div class="mt-4 h-[320px] md:h-[380px]">
                        <canvas id="report_chart" class="h-full w-full"></canvas>
                    </div>
                </section>

                <section class="rounded-3xl border border-white/10 bg-slate-900/60 p-6">
                    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-white">{{ ui['report_table_title'] }}</h2>
                        </div>
                        <div class="text-left md:text-right">
                            <p class="text-xs uppercase tracking-wide text-slate-500">{{ ui['temp_table_average_label'] }}</p>
                            <p class="mt-2 text-3xl font-semibold text-white">
                                {% if temperature_average is not none %}
                                    {{ '%.2f'|format(temperature_average) }} °C
                                {% else %}
                                    --
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="mt-4 overflow-x-auto">
                        <table class="w-full min-w-[640px] text-left text-sm text-slate-100">
                            <thead class="text-xs uppercase tracking-wide text-slate-400">
                            <tr class="border-b border-white/5">
                                <th class="px-3 py-2">{{ ui['report_table_period'] }}</th>
                                <th class="px-3 py-2">{{ ui['report_table_temp_avg'] }}</th>
                                <th class="px-3 py-2">{{ ui['report_table_temp_min'] }}</th>
                                <th class="px-3 py-2">{{ ui['report_table_temp_max'] }}</th>
                                <th class="px-3 py-2">{{ ui['report_table_precip'] }}</th>
                                <th class="px-3 py-2">{{ ui['report_table_sunshine'] }}</th>
                            </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5 text-sm">
                            {% for row in report.periods %}
                                {% set detail_id = 'period-detail-' ~ loop.index0 %}
                                <tr class="align-middle" data-period-row>
                                    <td class="px-3 py-2">
                                        <button type="button"
                                                class="flex w-full items-center gap-3 text-left text-sm font-semibold text-white"
                                                data-period-toggle
                                                aria-expanded="false"
                                                aria-controls="{{ detail_id }}">
                                            <span class="flex h-6 w-6 items-center justify-center rounded-full border border-white/20 text-xs text-white/80">
                                                <svg viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                                     stroke-width="2" class="h-3 w-3 transition-transform duration-200"
                                                     data-toggle-icon>
                                                    <path d="M7 5l6 5-6 5" stroke-linecap="round"
                                                          stroke-linejoin="round"/>
                                                </svg>
                                            </span>
                                            <span>{{ row.period }}</span>
                                        </button>
                                    </td>
                                    <td class="px-3 py-2">{{ '%.2f'|format(row.temp_avg) if row.temp_avg is not none else '—' }}</td>
                                    <td class="px-3 py-2">{{ '%.2f'|format(row.temp_min) if row.temp_min is not none else '—' }}</td>
                                    <td class="px-3 py-2">{{ '%.2f'|format(row.temp_max) if row.temp_max is not none else '—' }}</td>
                                    <td class="px-3 py-2">{{ '%.2f'|format(row.precipitation) if row.precipitation is not none else '—' }}</td>
                                    <td class="px-3 py-2">{{ '%.2f'|format(row.sunshine) if row.sunshine is not none else '—' }}</td>
                                </tr>
                                <tr id="{{ detail_id }}" class="hidden bg-slate-900/40" data-period-detail>
                                    <td colspan="6" class="px-3 py-4">
                                        <div class="rounded-2xl border border-white/5 bg-slate-950/60 p-4">
                                            <div class="flex flex-col gap-1 text-sm text-slate-400 md:flex-row md:items-start md:justify-between">
                                                <div>
                                                    <p class="text-xs uppercase tracking-wide text-slate-500">
                                                        {{ ui['report_period_details_heading'] }}
                                                    </p>
                                                    <p>{{ ui['report_period_details_subtitle'] }}</p>
                                                </div>
                                                <div class="text-xs text-slate-500 md:text-right">
                                                    {{ ui['report_table_period'] }}: <span
                                                        class="font-semibold text-slate-200">{{ row.period }}</span>
                                                </div>
                                            </div>
                                            {% if row.stations %}
                                                <div class="mt-4 overflow-x-auto">
                                                    <table class="w-full min-w-[560px] text-left text-xs text-slate-200 md:text-sm">
                                                        <thead>
                                                        <tr class="text-xs uppercase text-slate-400">
                                                            <th class="py-2 pr-4 font-semibold">{{ ui['temp_table_station'] }}</th>
                                                            <th class="py-2 pr-4 font-semibold">{{ ui['temp_table_distance'] }}</th>
                                                            <th class="py-2 pr-4 font-semibold">{{ ui['report_table_temp_avg'] }}</th>
                                                            <th class="py-2 pr-4 font-semibold">{{ ui['report_table_temp_min'] }}</th>
                                                            <th class="py-2 pr-4 font-semibold">{{ ui['report_table_temp_max'] }}</th>
                                                            <th class="py-2 pr-4 font-semibold">{{ ui['report_table_precip'] }}</th>
                                                            <th class="py-2 pr-4 font-semibold">{{ ui['report_table_sunshine'] }}</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody class="divide-y divide-white/5">
                                                        {% for station in row.stations %}
                                                            <tr>
                                                                <td class="py-3 pr-4">
                                                                    <div class="font-semibold text-white">{{ station.station_name or ui['region_station_unknown'] }}</div>
                                                                    <div class="text-xs text-slate-400">
                                                                        ID {{ station.station_id }}
                                                                        {% if station.state %}·
                                                                            {{ station.state }}{% endif %}
                                                                    </div>
                                                                </td>
                                                                <td class="py-3 pr-4">
                                                                    {% if station.distance_km is not none %}
                                                                        {{ '%.2f'|format(station.distance_km) }} km
                                                                    {% else %}
                                                                        –
                                                                    {% endif %}
                                                                </td>
                                                                <td class="py-3 pr-4">{{ '%.2f'|format(station.temp_avg) if station.temp_avg is not none else '—' }}</td>
                                                                <td class="py-3 pr-4">{{ '%.2f'|format(station.temp_min) if station.temp_min is not none else '—' }}</td>
                                                                <td class="py-3 pr-4">{{ '%.2f'|format(station.temp_max) if station.temp_max is not none else '—' }}</td>
                                                                <td class="py-3 pr-4">{{ '%.2f'|format(station.precipitation) if station.precipitation is not none else '—' }}</td>
                                                                <td class="py-3 pr-4">{{ '%.2f'|format(station.sunshine) if station.sunshine is not none else '—' }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            {% else %}
                                                <p class="mt-4 text-sm text-slate-400">{{ ui['report_period_details_empty'] }}</p>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="rounded-3xl border border-white/10 bg-slate-900/60 p-6">
                    <h2 class="text-lg font-semibold text-white">{{ ui['report_stations_heading'] }}</h2>
                    <ul class="mt-4 space-y-2 text-sm text-slate-200">
                        {% for station in report.stations %}
                            <li class="rounded-xl border border-white/5 bg-white/5 px-3 py-2">
                                <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                    <div class="text-sm">
                                        {{ station.name or station.station_id }}
                                        {% if station.state %} · {{ station.state }}{% endif %}
                                        {% if station.distance_km is not none %}
                                            ·
                                            {{ ui['report_station_distance'].replace('{distance}', ('%.2f'|format(station.distance_km))) }}
                                        {% endif %}
                                    </div>
                                    <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold {{ 'bg-lime-400/20 text-lime-200 border border-lime-300/40' if station.has_data else 'bg-slate-700/40 text-slate-300 border border-white/10' }}">
                                        {{ ui['report_station_badge_used'] if station.has_data else ui['report_station_badge_unused'] }}
                                    </span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </section>
            {% else %}
                <section
                        class="rounded-3xl border border-white/10 bg-slate-900/60 p-8 text-center text-sm text-slate-200">
                    <p>{{ error_message }}</p>
                    <a href="{{ url_for('index') }}"
                       class="mt-4 inline-flex items-center justify-center rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm text-slate-200 transition hover:border-lime-400 hover:text-white">
                        {{ ui['brand'] }}
                    </a>
                </section>
            {% endif %}
        </main>
    </div>
</div>

<footer class="border-t border-white/10 bg-slate-950/80 py-6 text-sm text-slate-400">
    <div class="mx-auto flex w-full max-w-6xl flex-col gap-2 px-6 md:flex-row md:items-center md:justify-between md:px-12">
        <span>© {{ ui['title'] }}</span>
        <div class="flex items-center gap-3">
            <a href="{{ url_for('index') }}" class="text-slate-400 transition hover:text-lime-300">{{ ui['brand'] }}</a>
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('auth.admin') }}" class="text-slate-400 transition hover:text-lime-300">Admin</a>
            {% else %}
                <a href="{{ url_for('auth.login') }}" class="text-slate-400 transition hover:text-lime-300">Login</a>
            {% endif %}
        </div>
    </div>
</footer>

{% if report %}
    <script>
        const REPORT_CHART_DATA = {{ chart_data|tojson }};
        document.addEventListener('DOMContentLoaded', () => {
            if (!REPORT_CHART_DATA) return;
            const ctx = document.getElementById('report_chart');
            if (!ctx) return;
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: REPORT_CHART_DATA.labels,
                    datasets: [
                        {
                            type: 'line',
                            label: REPORT_CHART_DATA.labelsTemp,
                            data: REPORT_CHART_DATA.tempAvg,
                            borderColor: '#38bdf8',
                            backgroundColor: 'rgba(56, 189, 248, 0.25)',
                            tension: 0.2,
                            yAxisID: 'y',
                        },
                        {
                            label: REPORT_CHART_DATA.labelsPrecip,
                            data: REPORT_CHART_DATA.precipitation,
                            backgroundColor: 'rgba(165, 243, 252, 0.45)',
                            borderColor: 'rgba(165, 243, 252, 0.7)',
                            yAxisID: 'y1',
                        },
                        {
                            label: REPORT_CHART_DATA.labelsSunshine,
                            data: REPORT_CHART_DATA.sunshine,
                            backgroundColor: 'rgba(190, 242, 100, 0.35)',
                            borderColor: 'rgba(190, 242, 100, 0.7)',
                            yAxisID: 'y1',
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {mode: 'index', intersect: false},
                    scales: {
                        y: {
                            position: 'left',
                            ticks: {color: '#bae6fd'},
                            grid: {color: 'rgba(148, 163, 184, 0.15)'},
                        },
                        y1: {
                            position: 'right',
                            ticks: {color: '#bbf7d0'},
                            grid: {drawOnChartArea: false},
                        },
                        x: {
                            ticks: {color: '#cbd5f5'},
                            grid: {color: 'rgba(148, 163, 184, 0.1)'},
                        },
                    },
                    plugins: {legend: {labels: {color: '#e2e8f0'}}},
                },
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggles = document.querySelectorAll('[data-period-toggle]');
            toggles.forEach((button) => {
                button.addEventListener('click', () => {
                    const targetId = button.getAttribute('aria-controls');
                    const detailRow = targetId ? document.getElementById(targetId) : null;
                    if (!detailRow) return;
                    const expanded = button.getAttribute('aria-expanded') === 'true';
                    button.setAttribute('aria-expanded', String(!expanded));
                    detailRow.classList.toggle('hidden', expanded);
                    const icon = button.querySelector('[data-toggle-icon]');
                    if (icon) {
                        icon.classList.toggle('rotate-90', !expanded);
                    }
                });
            });
        });
    </script>
{% endif %}
</body>
</html>
