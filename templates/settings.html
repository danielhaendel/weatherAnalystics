<!doctype html>
<html lang="{{ ui['html_lang'] }}">
<head>
    <meta charset="utf-8">
    <title>{{ ui['settings_page_title'] }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600&display=swap"
          rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont;
        }
    </style>
</head>
<body class="theme-dark min-h-screen bg-slate-950 text-slate-100">
{% set loader_text = ui['settings_loader_text'] %}{% include '_loader.html' %}
<header class="border-b border-white/10 bg-slate-900/80">
    <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-4">
        <div>
            <p class="header-tagline text-xs uppercase tracking-[0.35em]">{{ ui['settings_header_tagline'] }}</p>
            <h1 class="text-2xl font-semibold">{{ ui['settings_greeting']|replace('{name}', current_user.username) }}</h1>
        </div>
        <div class="flex flex-wrap items-center justify-end gap-3">
            <a href="{{ url_for('index') }}" class="header-link text-sm">{{ ui['back_to_home'] }}</a>
            <form method="post" action="{{ url_for('auth.logout') }}" data-show-loader="true">
                <button type="submit" class="text-sm text-slate-400 transition hover:text-red-300">{{ ui['settings_logout'] }}</button>
            </form>
        </div>
    </div>
</header>

{% set flashes = get_flashed_messages(with_categories=True) %}

<main class="mx-auto flex w-full max-w-6xl flex-1 gap-8 px-6 py-10 pb-16 min-h-[calc(100vh-160px)]">
    <aside class="w-full max-w-xs rounded-2xl border border-white/10 bg-slate-900/70 p-6">
        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">{{ ui['settings_nav_heading'] }}</p>
        {% set labels = {'data': ui['settings_nav_data'], 'api_keys': ui['settings_nav_api_keys'], 'password': ui['settings_nav_password']} %}
        <nav class="mt-4 flex flex-col gap-1 text-sm">
            {% for sec in available_sections %}
                <a href="{{ url_for('auth.admin', section=sec) }}"
                   class="flex items-center justify-between rounded-xl px-4 py-3 transition {{ 'bg-white/5 text-white border border-white/15' if active_section == sec else 'text-slate-400 hover:bg-white/5 hover:text-white border border-transparent' }}">
                    <span>{{ labels[sec] }}</span>
                </a>
            {% endfor %}
        </nav>
    </aside>

    <section class="flex-1 space-y-6">
        {% if active_section == 'password' %}
            <div class="flex h-full flex-col rounded-2xl border border-white/10 bg-slate-900/70 p-6 min-h-[calc(100vh-220px)]">
                <h2 class="text-xl font-semibold text-white">{{ ui['settings_password_heading'] }}</h2>
                <p class="mt-1 text-sm text-slate-400">{{ ui['settings_password_subheading'] }}</p>
                <form method="post" action="{{ url_for('auth.change_password') }}" class="mt-6 space-y-4"
                      data-show-loader="true">
                    <div>
                        <label for="current_password" class="block text-sm font-medium text-slate-300">{{ ui['settings_password_current_label'] }}</label>
                        <input id="current_password" name="current_password" type="password" required
                               autocomplete="current-password"
                               class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-950 px-3 py-2 text-slate-100 focus:border-lime-400 focus:outline-none focus:ring-2 focus:ring-lime-500/40">
                    </div>
                    <div class="grid gap-4 md:grid-cols-2">
                        <div>
                            <label for="new_password" class="block text-sm font-medium text-slate-300">{{ ui['settings_password_new_label'] }}</label>
                            <input id="new_password" name="new_password" type="password" required
                                   autocomplete="new-password"
                                   class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-950 px-3 py-2 text-slate-100 focus:border-lime-400 focus:outline-none focus:ring-2 focus:ring-lime-500/40">
                        </div>
                        <div>
                            <label for="confirm_password"
                                   class="block text-sm font-medium text-slate-300">{{ ui['settings_password_confirm_label'] }}</label>
                            <input id="confirm_password" name="confirm_password" type="password" required
                                   autocomplete="new-password"
                                   class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-950 px-3 py-2 text-slate-100 focus:border-lime-400 focus:outline-none focus:ring-2 focus:ring-lime-500/40">
                        </div>
                    </div>
                    <button type="submit"
                            class="w-full rounded-xl bg-gradient-to-r from-lime-400 via-emerald-400 to-sky-400 px-4 py-2 text-slate-950 font-semibold transition hover:brightness-110 focus:outline-none focus:ring-4 focus:ring-lime-300/50">
                        {{ ui['settings_password_submit'] }}
                    </button>
                </form>
            </div>
        {% elif active_section == 'data' %}
            <div class="flex h-full flex-col rounded-2xl border border-white/10 bg-slate-900/70 p-6 min-h-[calc(100vh-220px)]">
                <h2 class="text-xl font-semibold text-white">{{ ui['settings_data_heading'] }}</h2>
                <p class="mt-1 text-sm text-slate-400">{{ ui['settings_data_subheading'] }}</p>
                <div class="mt-6 space-y-4">
                    <form class="space-y-2" data-import-kind="stations">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-white">{{ ui['settings_data_stations_title'] }}</p>
                                <p class="text-xs text-slate-400">{{ ui['settings_data_stations_description'] }}</p>
                            </div>
                            <button type="button" data-import-trigger="stations"
                                    class="rounded-lg border border-white/15 bg-white/5 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:border-lime-400 hover:bg-white/10 disabled:cursor-not-allowed disabled:opacity-60">
                                {{ ui['settings_data_action_start'] }}
                            </button>
                        </div>
                    </form>
                    <form class="space-y-2" data-import-kind="weather">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-white">{{ ui['settings_data_weather_title'] }}</p>
                                <p class="text-xs text-slate-400">{{ ui['settings_data_weather_description'] }}</p>
                            </div>
                            <button type="button" data-import-trigger="weather"
                                    class="rounded-lg border border-white/15 bg-white/5 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:border-sky-400 hover:bg-white/10 disabled:cursor-not-allowed disabled:opacity-60">
                                {{ ui['settings_data_action_start'] }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        {% elif active_section == 'api_keys' %}
            <div class="flex h-full flex-col rounded-2xl border border-white/10 bg-slate-900/70 p-6 min-h-[calc(100vh-220px)]">
                <h2 class="text-xl font-semibold text-white">{{ ui['settings_api_heading'] }}</h2>
                <p class="mt-1 text-sm text-slate-400">{{ ui['settings_api_subheading'] }}</p>
                {% if new_api_key %}
                    <div class="mt-4 rounded-2xl border border-lime-300/40 bg-white/10 p-4 text-sm text-white">
                        <p class="font-semibold">{{ ui['settings_api_new_label'] }}</p>
                        <p class="mt-1 text-xs text-slate-300">{{ ui['settings_api_new_hint'] }}</p>
                        <code class="mt-2 block select-all rounded-xl bg-black/30 px-3 py-2 text-sm tracking-wide">{{ new_api_key }}</code>
                    </div>
                {% endif %}
                <form method="post" action="{{ url_for('auth.create_api_key') }}" class="mt-6 space-y-4"
                      data-show-loader="true">
                    <div>
                        <label for="api_key_name" class="block text-sm font-medium text-slate-300">{{ ui['settings_api_name_label'] }}</label>
                        <input id="api_key_name" name="name" type="text" required placeholder="{{ ui['settings_api_name_placeholder'] }}"
                               class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-950 px-3 py-2 text-slate-100 focus:border-lime-400 focus:outline-none focus:ring-2 focus:ring-lime-500/40">
                    </div>
                    <div>
                        <label for="expires_in" class="block text-sm font-medium text-slate-300">{{ ui['settings_api_expiry_label'] }}</label>
                        <input id="expires_in" name="expires_in" type="number" min="1" max="360" value="90"
                               class="mt-1 w-full rounded-xl border border-slate-700 bg-slate-950 px-3 py-2 text-slate-100 focus:border-lime-400 focus:outline-none focus:ring-2 focus:ring-lime-500/40">
                    </div>
                    <button type="submit"
                            class="w-full rounded-xl bg-gradient-to-r from-sky-400 via-cyan-400 to-lime-400 px-4 py-2 text-slate-950 font-semibold transition hover:brightness-110 focus:outline-none focus:ring-4 focus:ring-cyan-300/50">
                        {{ ui['settings_api_create_button'] }}
                    </button>
                </form>
                <div class="mt-6 flex-1">
                    {% if api_keys %}
                        <div class="overflow-x-auto rounded-2xl border border-white/5 bg-white/5">
                            <table class="w-full min-w-[520px] text-left text-sm">
                                <thead class="text-xs uppercase text-slate-400">
                                <tr>
                                    <th class="px-4 py-3">{{ ui['settings_api_table_name'] }}</th>
                                    <th class="px-4 py-3">{{ ui['settings_api_table_key'] }}</th>
                                    <th class="px-4 py-3">{{ ui['settings_api_table_created'] }}</th>
                                    <th class="px-4 py-3">{{ ui['settings_api_table_expires'] }}</th>
                                    <th class="px-4 py-3 text-right">{{ ui['settings_api_table_actions'] }}</th>
                                </tr>
                                </thead>
                                <tbody class="divide-y divide-white/10 text-slate-100">
                                {% for key in api_keys %}
                                    {% set expired = api_key_now and key['expires_at'] <= api_key_now %}
                                    <tr>
                                        <td class="px-4 py-3 font-semibold">{{ key['name'] }}</td>
                                        <td class="px-4 py-3">
                                            <code class="rounded bg-black/30 px-2 py-1 text-xs tracking-wide">{{ key['api_key'] }}</code>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-slate-300">{{ key['created_at'] }}</td>
                                        <td class="px-4 py-3 text-sm {{ 'text-red-300' if expired else 'text-slate-300' }}">{{ key['expires_at'] }}</td>
                                        <td class="px-4 py-3 text-right">
                                            <form method="post"
                                                  action="{{ url_for('auth.delete_api_key', key_id=key['id']) }}"
                                                  onsubmit="return confirm('{{ ui['settings_api_delete_confirm'] }}');">
                                                <button type="submit"
                                                        class="rounded-full border border-white/20 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-red-400 hover:text-red-200">
                                                    {{ ui['settings_api_delete_button'] }}
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="mt-4 text-sm text-slate-400">{{ ui['settings_api_empty_state'] }}</p>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </section>
</main>

<div id="toast_container" class="fixed right-6 top-6 z-50 flex w-full max-w-sm flex-col items-end" aria-live="polite"
     aria-atomic="true"></div>
<script src="{{ url_for('static', filename='js/app.js') }}" defer></script>
{% include '_app_i18n_context.html' %}
<script type="application/json" id="flash-data">{{ flashes|tojson }}</script>
<script>
    (function () {
        const container = document.getElementById('toast_container');
        const dataEl = document.getElementById('flash-data');
        if (!container || !dataEl) return;

        const VARIANTS = {
            success: {
                border: 'border-emerald-500/40',
                iconBg: 'bg-emerald-500/10 text-emerald-300',
                icon: '<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>'
            },
            info: {
                border: 'border-sky-500/40',
                iconBg: 'bg-sky-500/10 text-sky-300',
                icon: '<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            },
            warning: {
                border: 'border-amber-400/40',
                iconBg: 'bg-amber-400/10 text-amber-200',
                icon: '<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01M10.29 3.86l-8.59 14.8A1 1 0 002.58 20h18.84a1 1 0 00.87-1.52L13.71 3.86a1 1 0 00-1.74 0z"/></svg>'
            },
            error: {
                border: 'border-rose-500/40',
                iconBg: 'bg-rose-500/10 text-rose-300',
                icon: '<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>'
            },
        };

        function showToast({kind = 'info', title = '', message = '', autoDismiss = true, duration = 6000}) {
            if (!title && !message) return;
            const variant = VARIANTS[kind] || VARIANTS.info;
            const toast = document.createElement('div');
            toast.className = `admin-toast relative flex items-center w-full max-w-sm gap-3 p-4 pb-6 mb-4 rounded-2xl border shadow-lg backdrop-blur-xl transform transition-all duration-300 ease-out translate-x-6 opacity-0 ${variant.border}`;
            toast.setAttribute('role', 'alert');

            const iconWrapper = document.createElement('div');
            iconWrapper.className = `inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full ${variant.iconBg}`;
            iconWrapper.innerHTML = variant.icon;

            const textWrapper = document.createElement('div');
            textWrapper.className = 'flex flex-col text-sm';

            if (title) {
                const titleEl = document.createElement('div');
                titleEl.className = 'font-semibold text-white';
                titleEl.textContent = title;
                textWrapper.appendChild(titleEl);
            }

            if (message) {
                const messageEl = document.createElement('div');
                messageEl.className = `${title ? 'mt-1' : ''} text-slate-300`;
                messageEl.textContent = message;
                textWrapper.appendChild(messageEl);
            }

            if (!title && !message) {
                textWrapper.textContent = '';
            }

            const closeButton = document.createElement('button');
            closeButton.type = 'button';
            closeButton.className = 'admin-toast__close ml-auto inline-flex h-8 w-8 items-center justify-center rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500/60';
            closeButton.innerHTML = '<span class="sr-only">{{ ui["settings_toast_close"] }}</span><svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>';

            let timer = null;
            let startTime = Date.now();
            let remaining = duration;

            const progressWrapper = document.createElement('div');
            progressWrapper.className = 'pointer-events-none absolute inset-x-4 bottom-3 h-1 rounded-full bg-slate-200/70 dark:bg-slate-800/70';
            const progressBar = document.createElement('span');
            progressBar.className = 'block h-full w-full rounded-full bg-gradient-to-r from-lime-400 via-emerald-400 to-sky-400';
            progressWrapper.appendChild(progressBar);

            const removeToast = () => {
                if (timer) clearTimeout(timer);
                toast.classList.remove('translate-x-0', 'opacity-100');
                toast.classList.add('translate-x-6', 'opacity-0');
                setTimeout(() => toast.remove(), 260);
            };

            closeButton.addEventListener('click', removeToast);

            if (autoDismiss) {
                progressBar.style.width = '100%';
                requestAnimationFrame(() => {
                    progressBar.style.transition = `width linear ${duration}ms`;
                    progressBar.style.width = '0%';
                });
                startTime = Date.now();
                timer = setTimeout(removeToast, duration);
            } else {
                progressWrapper.classList.add('hidden');
            }

            toast.addEventListener('mouseenter', () => {
                if (!autoDismiss || !timer) return;
                const elapsed = Date.now() - startTime;
                remaining = Math.max(0, duration - elapsed);
                clearTimeout(timer);
                timer = null;
                progressBar.style.transition = 'none';
                progressBar.style.width = `${(remaining / duration) * 100}%`;
                progressBar.getBoundingClientRect();
            });

            toast.addEventListener('mouseleave', () => {
                if (!autoDismiss || timer || remaining <= 0) return;
                startTime = Date.now();
                requestAnimationFrame(() => {
                    progressBar.style.transition = `width linear ${remaining}ms`;
                    progressBar.style.width = '0%';
                });
                timer = setTimeout(removeToast, remaining);
            });

            toast.appendChild(iconWrapper);
            toast.appendChild(textWrapper);
            toast.appendChild(closeButton);
            toast.appendChild(progressWrapper);
            container.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-6', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            });
        }

        window.adminShowToast = showToast;
        let messages = [];
        try {
            messages = JSON.parse(dataEl.textContent || '[]');
        } catch (err) {
            console.warn('Flash-Meldungen nicht lesbar:', err);
        }
        messages.forEach(([category, message]) => {
            showToast({kind: String(category || 'info').toLowerCase(), message, autoDismiss: true, duration: 6000});
        });
    })();

    (function () {
        const overlay = document.getElementById('loading_overlay');
        const triggerButtons = Array.from(document.querySelectorAll('[data-import-trigger]'));
        if (!overlay || !triggerButtons.length) return;

        const loaderTextEl = overlay.querySelector('.loading-overlay__text');
        const defaultOverlayText = loaderTextEl ? loaderTextEl.getAttribute('data-default-text') || loaderTextEl.textContent : '';
        const progressBar = overlay.querySelector('[data-progress-bar]');
        const progressMessage = overlay.querySelector('[data-progress-message]');
        const progressDetail = overlay.querySelector('[data-progress-detail]');
        const showToast = window.adminShowToast || function () {};
        const startUrl = "{{ url_for('auth.admin_import_start') }}";
        const statusUrlTemplate = "{{ url_for('auth.admin_import_status', job_id='__JOB__') }}";
        const stageLabels = {
            prepare: {{ ui['settings_import_stage_prepare']|tojson }},
            stations: {{ ui['settings_import_stage_stations']|tojson }},
            daily: {{ ui['settings_import_stage_daily']|tojson }},
            complete: {{ ui['settings_import_stage_complete']|tojson }},
        };

        const successTitle = {{ ui['settings_import_success_title']|tojson }};
        const stationFallback = {{ ui['settings_import_station_fallback']|tojson }};
        const weatherFallback = {{ ui['settings_import_weather_fallback']|tojson }};
        const summaryTemplates = {
            stations: {{ ui['settings_import_summary_stations']|tojson }},
            records: {{ ui['settings_import_summary_records']|tojson }},
            both: {{ ui['settings_import_summary_both']|tojson }},
            archives: {{ ui['settings_import_summary_archives']|tojson }},
            archivesFailed: {{ ui['settings_import_summary_archives_failed']|tojson }},
        };
        const detailTemplates = {
            stations: {{ ui['settings_import_detail_stations']|tojson }},
            records: {{ ui['settings_import_detail_records']|tojson }},
        };
        const buttonLabelDefault = {{ ui['settings_import_button_start']|tojson }};
        const buttonLabelRunning = {{ ui['settings_import_button_running']|tojson }};
        const importMessages = {
            failed: {{ i18n_messages['admin_import_failed']|default('Import fehlgeschlagen.')|tojson }},
            statusMissing: {{ i18n_messages['admin_import_status_missing']|default('Kein Jobstatus verfÃ¼gbar.')|tojson }},
            statusError: {{ i18n_messages['admin_import_status_error']|default('Status konnte nicht geladen werden.')|tojson }},
            startFailed: {{ i18n_messages['admin_import_start_failed']|default('Konnte Job nicht starten.')|tojson }},
        };

        let pollTimer = null;
        let activeJob = null;
        const COMPLETED_STATES = new Set(['completed', 'finished']);

        function clearTimer() {
            if (pollTimer) {
                clearTimeout(pollTimer);
                pollTimer = null;
            }
        }

        function showOverlay(on) {
            overlay.classList.toggle('is-visible', on);
            overlay.setAttribute('aria-hidden', String(!on));
        }

        function parseCount(value) {
            const num = Number(value);
            return Number.isFinite(num) ? num : 0;
        }

        function formatText(template, replacements) {
            if (!template) return '';
            return Object.entries(replacements || {}).reduce(
                (acc, [key, value]) => acc.replace(new RegExp(`\\{${key}\\}`, 'g'), String(value)),
                template,
            );
        }

        function sumCounts(inserted, updated) {
            return parseCount(inserted) + parseCount(updated);
        }

        function buildSuccessToast(job) {
            const defaultToast = {title: successTitle, message: ''};
            if (!job) return defaultToast;
            const summary = (job.detail && job.detail.summary) || '';
            if (summary) {
                return {title: successTitle, message: summary};
            }
            const result = job.result || {};
            if (job.job_type === 'stations') {
                const totalStations = sumCounts(
                    result.inserted ?? result?.stations?.inserted,
                    result.updated ?? result?.stations?.updated,
                );
                return totalStations
                    ? {
                        title: successTitle,
                        message: formatText(summaryTemplates.stations, {total: totalStations}),
                    }
                    : {title: successTitle, message: stationFallback};
            }
            if (job.job_type === 'weather') {
                const lines = [];
                const stationTotal = sumCounts(result?.stations?.inserted, result?.stations?.updated);
                const dailyTotal = sumCounts(result?.daily?.inserted, result?.daily?.updated);
                if (stationTotal && dailyTotal) {
                    lines.push(
                        formatText(summaryTemplates.both, {stations: stationTotal, records: dailyTotal}),
                    );
                } else if (stationTotal) {
                    lines.push(formatText(summaryTemplates.stations, {total: stationTotal}));
                } else if (dailyTotal) {
                    lines.push(formatText(summaryTemplates.records, {total: dailyTotal}));
                }
                const processed = parseCount(result?.daily?.archives_processed);
                if (processed) {
                    const failed = parseCount(result?.daily?.archives_failed);
                    const archiveText = failed
                        ? formatText(summaryTemplates.archivesFailed, {processed, failed})
                        : formatText(summaryTemplates.archives, {processed});
                    lines.push(archiveText);
                }
                return lines.length
                    ? {title: successTitle, message: lines.join('\n')}
                    : {title: successTitle, message: weatherFallback};
            }
            return defaultToast;
        }

        function setProgressDetail(text) {
            if (!progressDetail) return;
            progressDetail.innerHTML = '';
            if (!text) {
                progressDetail.hidden = true;
                return;
            }
            text.split('\n').forEach((line) => {
                const div = document.createElement('div');
                div.className = 'text-xs text-slate-300';
                div.textContent = line;
                progressDetail.appendChild(div);
            });
            progressDetail.hidden = false;
        }

        function updateProgress({percent = 0, message = '', detail = ''}) {
            if (progressBar) progressBar.style.width = `${Math.max(0, Math.min(100, percent))}%`;
            if (progressMessage) progressMessage.textContent = message || defaultOverlayText;
            setProgressDetail(detail);
        }

        async function pollJob(jobId) {
            const url = statusUrlTemplate.replace('__JOB__', encodeURIComponent(jobId));
            try {
                const resp = await fetch(url, {cache: 'no-store'});
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const payload = await resp.json();
                const job = payload?.job;
                if (!job) throw new Error(importMessages.statusMissing);
                const percent = (job.progress || 0) * 100;
                const detailLines = [];
                if (job.detail?.stations_inserted || job.detail?.stations_updated) {
                    detailLines.push(
                        formatText(detailTemplates.stations, {
                            inserted: job.detail.stations_inserted || 0,
                            updated: job.detail.stations_updated || 0,
                        }),
                    );
                }
                if (job.detail?.daily_inserted || job.detail?.daily_updated) {
                    detailLines.push(
                        formatText(detailTemplates.records, {
                            inserted: job.detail.daily_inserted || 0,
                            updated: job.detail.daily_updated || 0,
                        }),
                    );
                }
                updateProgress({
                    percent,
                    message: stageLabels[job.detail?.stage] || job.message || defaultOverlayText,
                    detail: detailLines.join('\n'),
                });

                const isCompleted = COMPLETED_STATES.has(job.status);
                const isFailed = job.status === 'failed';
                if (isCompleted || isFailed) {
                    clearTimer();
                    showOverlay(false);
                    if (isFailed) {
                        showToast({
                            kind: 'error',
                            message: job.detail?.summary || job.error || importMessages.failed,
                        });
                    } else {
                        const toastData = buildSuccessToast(job);
                        showToast({
                            kind: 'success',
                            title: toastData.title,
                            message: toastData.message,
                        });
                    }
                    triggerButtons.forEach((btn) => {
                        btn.disabled = false;
                        btn.textContent = buttonLabelDefault;
                    });
                    activeJob = null;
                    return;
                }

                pollTimer = setTimeout(() => pollJob(jobId), 2000);
            } catch (err) {
                console.error(err);
                showToast({kind: 'error', message: err.message || importMessages.statusError});
                clearTimer();
                showOverlay(false);
                triggerButtons.forEach((btn) => {
                    btn.disabled = false;
                    btn.textContent = buttonLabelDefault;
                });
                activeJob = null;
            }
        }

        triggerButtons.forEach((btn) => {
            btn.addEventListener('click', async () => {
                if (btn.disabled || activeJob) return;
                const kind = btn.dataset.importTrigger;
                if (!kind) return;
                triggerButtons.forEach((button) => {
                    button.disabled = true;
                    button.textContent = buttonLabelRunning;
                });
                showOverlay(true);
                updateProgress({percent: 0, message: stageLabels.prepare});
                try {
                    const resp = await fetch(startUrl, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({kind}),
                    });
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    const data = await resp.json();
                    if (!data?.job_id) throw new Error(importMessages.startFailed);
                    activeJob = data.job_id;
                    pollJob(activeJob);
                } catch (err) {
                    console.error(err);
                    showToast({kind: 'error', message: err.message || importMessages.startFailed});
                    showOverlay(false);
                    triggerButtons.forEach((button) => {
                        button.disabled = false;
                        button.textContent = buttonLabelDefault;
                    });
                }
            });
        });
    })();
</script>
